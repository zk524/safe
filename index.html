<button id="connectWallet">Connect Wallet</button>
<span id="currentAddress"></span><br><br>
<span>Owners (split by ',')</span><br>
<input id="owners" value="" /><br>
<span>Threshold</span><br>
<input id="threshold" value="1" type="number" /><br>
<span>SaltNonce(unit256)</span><br>
<input id="salt" value="0" type="number" /><br>
<span id="proxyAddress">Proxy Address: </span><br>
<button id="calcAddress">Calculate ProxyAddress</button>
<button id="create1">Create By Wallet</button>
<button id="create2">Create By RawTx</button><br>
<span>ChainId</span><br>
<input id="chainId" value="12227332" type="number" /><br>
<span>ProxyNonce</span><br>
<input id="proxyNonce" value="0" type="number" /><br>
<span>To</span><br>
<input id="to" value="" /><br>
<span>Value(Wei)</span><br>
<input id="value" value="0" /><br>
<span>Data</span><br>
<input id="data" /><br>
<button id="signTx">Send(Sign)</button><br>
<span id="signRecord"></span><br>
<span>Signatures (Ensure that the corresponding addresses are in ascending order)</span><br>
<div id="signatures">
    <input /><br>
    <button id="sigAdd">+</button>
    <button id="sigDel">-</button>
    <button id="execute1">Execute By Wallet</button>
    <button id="execute2">Execute By RawTx</button>
</div>
<textarea id="txn" rows="5" cols="50"></textarea><br>
<input id="rpc"><br>
<button id="submit1">Submit(SignedTx)</button>
<button id="submit2">Submit(RawTx)</button>
<button id="copy">Copy</button>
<button id="clear">Clear</button>

<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@latest/dist/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.9.3/sha3.min.js"></script>
<script type="module">
    ((s) => (s.textContent = `input{width: 425px;margin:3px 0} button{margin:3px 0};`, document.head.append(s)))(document.createElement('style'))
    import { ethers } from 'https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.min.js'
    const global = {}
    const BUF = _ => new Uint8Array((_.startsWith("0x") ? _.slice(2) : _).match(/.{1,2}/g).map(_ => parseInt(_, 16)))
    const CLK = (id, func) => document.getElementById(id).onclick = func
    const IDV = _ => document.getElementById(_).value
    const ZRO = "0x0000000000000000000000000000000000000000"
    const infuraId = "3fe9a51815de471c89a3a785796df184"
    const SafeProxyFactory = "0xa6B71E26C5e0845f74c812102Ca7114b6a896AB2"
    const SafeL2 = "0x3E5c63644E683549055b9Be8653de26E0B4CD36E"
    const FallbackHandler = "0xf48f2B2d2a534e402487b3ee7C18c33Aec0Fe5e4"
    const ABI = ["function setup(address[],uint256,address,bytes,address,address,uint256,address)",
        "function execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)",
        "function createProxyWithNonce(address,bytes,uint256)"]
    const rpc = "https://neoxt4seed1.ngd.network"
    const proxy_creation_code = "0x608060405234801561001057600080fd5b506040516101e63803806101e68339818101604052602081101561003357600080fd5b8101908080519060200190929190505050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614156100ca576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001806101c46022913960400191505060405180910390fd5b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505060ab806101196000396000f3fe608060405273ffffffffffffffffffffffffffffffffffffffff600054167fa619486e0000000000000000000000000000000000000000000000000000000060003514156050578060005260206000f35b3660008037600080366000845af43d6000803e60008114156070573d6000fd5b3d6000f3fea2646970667358221220d1429297349653a4918076d650332de1a1068c5f3e07c5c82360c277770b955264736f6c63430007060033496e76616c69642073696e676c65746f6e20616464726573732070726f7669646564"
    const initializer = () => BUF(new ethers.Interface(ABI).encodeFunctionData('setup', [IDV("owners").split(","), IDV("threshold"), ZRO, "0x", FallbackHandler, ZRO, 0, ZRO]))
    const calc_proxy_address = () => "0x" + keccak256(new Uint8Array([
        BUF("ff"), BUF(SafeProxyFactory),
        BUF(keccak256(BUF(ethers.solidityPacked(["bytes32", "uint256"], ["0x" + keccak256(initializer()), BigInt(IDV("salt"))])))),
        BUF(keccak256(BUF(ethers.solidityPacked(["bytes", "uint256"], [proxy_creation_code, BigInt(SafeL2)]))))
    ].reduce((a, v) => a.concat(...v), []))).slice(-40)
    const connect = (w3) => Promise.resolve(global.instance).then(async (I) => I ? I : (global.instance = await w3.connect())).then((I) => {
        I.on("accountsChanged", ([_]) => (document.getElementById("currentAddress").innerText = _ ?? ""))
        I.on("chainChanged", _ => window.location.reload())
        I.on("disconnect", _ => (document.getElementById("currentAddress").innerText = ""))
        return new ethers.BrowserProvider(I).getSigner()
    }).then((s) => (global.signer = s).getAddress()).then((_) => (document.getElementById("owners").value = document.getElementById("currentAddress").innerText = _)).catch(console.log)
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("rpc").value = rpc
        const web3Modal = new window.Web3Modal.default({ cacheProvider: true, subscribeProvider: true, providerOptions: { walletconnect: { package: WalletConnectProvider.default, options: { infuraId } } } })
        if (web3Modal.cachedProvider) connect(web3Modal)
        CLK("connectWallet", () => connect(web3Modal))
        CLK("calcAddress", () => (document.getElementById("proxyAddress").innerText = "Proxy Address: " + calc_proxy_address()))
        CLK("create1", () => new ethers.Contract(SafeProxyFactory, ABI, global.signer)['createProxyWithNonce'](SafeL2, initializer(), BigInt(IDV("salt"))).then(tx => (prompt("Transaction sent: ", tx.hash), console.log(tx.hash))).catch(console.log))
        CLK("create2", () => document.getElementById("txn").value = ethers.Transaction.from({ to: SafeProxyFactory, data: new ethers.Interface(ABI).encodeFunctionData('createProxyWithNonce', [SafeL2, initializer(), BigInt(IDV("salt"))]) }).unsignedSerialized)
        CLK("signTx", () => global.signer.signTypedData({ chainId: IDV("chainId"), verifyingContract: calc_proxy_address() }, { SafeTx: ["to", "value", "data", "operation", "safeTxGas", "baseGas", "gasPrice", "gasToken", "refundReceiver", "nonce"].map((name, i) => ({ name, type: ["address", "uint256", "bytes", "uint8", "uint256", "uint256", "uint256", "address", "address", "uint256"][i] })) }, { to: IDV("to"), value: IDV("value"), data: "0x", operation: 0, safeTxGas: 0, baseGas: 0, gasPrice: 0, gasToken: ZRO, refundReceiver: ZRO, nonce: IDV("proxyNonce") }).then(_ => ((rec) => (rec.innerText = "signature: " + _.slice(2), rec.style.cssText = 'color:red;font-size:12px;'))(document.getElementById("signRecord"))).catch(console.log))
        CLK("sigAdd", () => (document.getElementById("signatures").children.length / 2 - Number(IDV("threshold")) < 2) && ["input", "br"].forEach((e) => document.getElementById("sigAdd").insertAdjacentElement("beforebegin", document.createElement(e))))
        CLK("sigDel", () => (document.getElementById("signatures").children.length > 6) && [0, 0].forEach(_ => document.getElementById("sigAdd").previousElementSibling.remove()))
        CLK("execute1", () => new ethers.Contract(calc_proxy_address(), ABI, global.signer)["execTransaction"](IDV("to"), IDV("value"), "0x", 0, 0, 0, 0, ZRO, ZRO, "0x" + new Array(...document.querySelectorAll('div#signatures input')).map(v => v.value).join("")).then(tx => (prompt("Transaction sent: ", tx.hash), console.log(tx.hash))).catch(console.log))
        CLK("execute2", () => document.getElementById("txn").value = ethers.Transaction.from({ to: calc_proxy_address(), data: new ethers.Interface(ABI).encodeFunctionData('execTransaction', [IDV("to"), IDV("value"), "0x", 0, 0, 0, 0, ZRO, ZRO, "0x" + new Array(...document.querySelectorAll('div#signatures input')).map(v => v.value).join("")]) }).unsignedSerialized)
        CLK("copy", () => navigator.clipboard.writeText(IDV("txn")).then(_ => alert(`Copied`)).catch(console.log))
        CLK("clear", () => (document.getElementById("txn").value = ""))
        CLK("submit1", () => () => new ethers.JsonRpcProvider(IDV("rpc")).send('eth_sendRawTransaction', [IDV("txn")]).then(_ => confirm(_) && console.log(_)))
        CLK("submit2", () => Promise.resolve(ethers.Transaction.from(IDV("txn"))).then(({ to, data, value }) => global.signer.sendTransaction({ to, data, value })).then(tx => (prompt("Transaction sent: ", tx.hash), console.log(tx.hash))).catch(console.log))
    })
</script>
